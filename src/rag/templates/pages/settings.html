{% extends "base.html" %}
{% block title %}Einstellungen — Wissensdatenbank{% endblock %}
{% block page_title %}Einstellungen{% endblock %}

{% block content %}
<div x-data="settingsApp()" x-init="load()">
    <!-- System info -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <h3 class="font-semibold mb-4">System-Information</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <p class="text-gray-500">FastAPI</p>
                <p class="font-mono">http://192.168.178.182:8000</p>
            </div>
            <div>
                <p class="text-gray-500">LLM Backend</p>
                <p class="font-mono">http://192.168.178.8:54321/v1</p>
            </div>
            <div>
                <p class="text-gray-500">Whisper Server</p>
                <p class="font-mono">http://192.168.178.8:8765</p>
            </div>
            <div>
                <p class="text-gray-500">Qdrant</p>
                <p class="font-mono">localhost:6333</p>
            </div>
            <div>
                <p class="text-gray-500">Neo4j</p>
                <p class="font-mono">bolt://localhost:7687</p>
            </div>
            <div>
                <p class="text-gray-500">PostgreSQL</p>
                <p class="font-mono">localhost:5432</p>
            </div>
        </div>
    </div>

    <!-- Service health -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <h3 class="font-semibold mb-4">Service-Status</h3>
        <div class="grid grid-cols-3 gap-3">
            <template x-for="s in services" :key="s.name">
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                    <div class="w-2.5 h-2.5 rounded-full" :class="s.ok ? 'bg-green-500' : 'bg-red-500'"></div>
                    <span class="text-sm" x-text="s.name"></span>
                </div>
            </template>
        </div>
    </div>

    <!-- Tag management -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="font-semibold mb-4">Tags verwalten</h3>
        <div class="flex gap-2 mb-4">
            <input type="text" x-model="newTagName" placeholder="Tag-Name..." @keydown.enter="createTag()"
                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg text-sm">
            <input type="color" x-model="newTagColor" class="h-9 w-12 cursor-pointer rounded border border-gray-300 dark:border-gray-600">
            <button @click="createTag()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm hover:bg-primary-700">Erstellen</button>
        </div>
        <div class="space-y-2">
            <template x-for="tag in tags" :key="tag.id">
                <div class="flex items-center justify-between px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" :style="`background-color: ${tag.color || '#6B7280'}`"></span>
                        <span class="text-sm font-medium" x-text="tag.name"></span>
                        <span class="text-xs text-gray-400" x-text="tag.tag_type"></span>
                        <span class="text-xs text-gray-400" x-text="(tag.doc_count || 0) + ' Dokumente'"></span>
                    </div>
                    <button @click="deleteTag(tag)" class="text-gray-400 hover:text-red-500 p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            </template>
            <div x-show="tags.length === 0" class="text-sm text-gray-400 py-4 text-center">Noch keine Tags erstellt</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsApp() {
    return {
        tags: [],
        services: [],
        newTagName: '',
        newTagColor: '#3B82F6',
        async load() {
            // Load tags
            try {
                const resp = await fetch('/api/tags');
                const data = await resp.json();
                this.tags = data.tags;
            } catch (e) {}

            // Check services
            this.services = [];
            const checks = [
                { name: 'FastAPI', url: '/health' },
                { name: 'LLM (Mac Studio)', url: null },
                { name: 'Whisper Server', url: null },
            ];
            // FastAPI
            try { const r = await fetch('/health'); this.services.push({ name: 'FastAPI', ok: r.ok }); } catch (e) { this.services.push({ name: 'FastAPI', ok: false }); }
            // Stats (checks Qdrant + PG)
            try { const r = await fetch('/stats'); this.services.push({ name: 'Qdrant + PostgreSQL', ok: r.ok }); } catch (e) { this.services.push({ name: 'Qdrant + PostgreSQL', ok: false }); }
            // Graph
            try { const r = await fetch('/api/graph/stats'); this.services.push({ name: 'Neo4j', ok: r.ok }); } catch (e) { this.services.push({ name: 'Neo4j', ok: false }); }
        },
        async createTag() {
            if (!this.newTagName.trim()) return;
            await fetch('/api/tags', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: this.newTagName, color: this.newTagColor }),
            });
            this.newTagName = '';
            showToast('Tag erstellt');
            this.load();
        },
        async deleteTag(tag) {
            if (!confirm(`Tag "${tag.name}" löschen?`)) return;
            await fetch(`/api/tags/${tag.id}`, { method: 'DELETE' });
            showToast('Tag gelöscht');
            this.load();
        }
    }
}
</script>
{% endblock %}
