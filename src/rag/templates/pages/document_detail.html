{% extends "base.html" %}
{% block title %}Dokument — Wissensdatenbank{% endblock %}
{% block page_title %}Dokument-Detail{% endblock %}

{% block content %}
<div x-data="documentDetail('{{ doc_id }}')" x-init="load()">
    <a href="/documents" class="text-sm text-primary-500 hover:text-primary-600 mb-4 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Zurück zur Liste
    </a>

    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6" x-show="doc">
        <div class="flex items-start justify-between">
            <div class="flex items-start gap-4 flex-1 min-w-0">
                <!-- YouTube Thumbnail -->
                <img x-show="ytThumbnail(doc?.source_url)" :src="ytThumbnail(doc?.source_url)"
                     class="w-40 h-[90px] object-cover rounded-lg flex-shrink-0 bg-gray-100 dark:bg-gray-700"
                     @error="$el.style.display='none'" loading="lazy">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold" x-text="doc?.title"></h2>
                    <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300" x-text="(doc?.platform || '').toUpperCase()"></span>
                        <span x-text="doc?.author || ''"></span>
                        <span x-show="doc?.published_at" x-text="'Erstellt am ' + (doc?.published_at ? new Date(doc.published_at).toLocaleDateString('de-DE') : '')"></span>
                        <span x-show="!doc?.published_at" x-text="doc?.ingested_at ? new Date(doc.ingested_at).toLocaleDateString('de-DE') : ''"></span>
                        <span class="text-gray-400" x-text="(doc?.chunk_count || 0) + ' Chunks · ' + (doc?.entity_count || 0) + ' Entities'"></span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
                <a x-show="doc?.source_url" :href="doc?.source_url" target="_blank"
                   class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Original</a>
                <button @click="reIngest()" :disabled="reIngesting" class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50">
                    <span x-show="!reIngesting">Re-Ingest</span>
                    <span x-show="reIngesting" class="flex items-center gap-1"><div class="animate-spin w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full"></div> Läuft...</span>
                </button>
                <button @click="confirmDelete()" class="px-3 py-1.5 text-sm text-red-600 border border-red-300 dark:border-red-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">Löschen</button>
            </div>
        </div>

        <!-- Quality rating -->
        <div class="flex items-center gap-4 mt-4">
            <span class="text-sm text-gray-500">Qualität:</span>
            <div class="flex gap-1">
                <template x-for="star in 5">
                    <button @click="setQuality(star)" class="focus:outline-none">
                        <svg class="w-5 h-5 cursor-pointer transition-colors" :class="star <= quality ? 'text-yellow-400' : 'text-gray-300 dark:text-gray-600 hover:text-yellow-300'" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                    </button>
                </template>
            </div>
            <button @click="toggleFlag()" class="ml-4 flex items-center gap-1 text-sm transition-colors" :class="flagged ? 'text-red-500' : 'text-gray-400 hover:text-red-500'">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z"/></svg>
                <span x-text="flagged ? 'Markiert' : 'Markieren'"></span>
            </button>
        </div>

        <!-- Tags with picker -->
        <div class="flex items-center gap-2 mt-4 flex-wrap">
            <span class="text-sm text-gray-500">Tags:</span>
            <template x-for="tag in (doc?.tags || [])" :key="tag.id">
                <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full" :style="`background-color: ${tag.color || '#6B7280'}20; color: ${tag.color || '#6B7280'}`">
                    <span x-text="tag.name"></span>
                    <button @click="removeTag(tag.id)" class="hover:text-red-500 ml-0.5">&times;</button>
                </span>
            </template>
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open; if(open) loadAllTags()" class="text-xs px-2 py-0.5 rounded-full border border-dashed border-gray-300 dark:border-gray-600 text-gray-400 hover:text-gray-600 hover:border-gray-400">+ Tag</button>
                <div x-show="open" @click.away="open = false" x-transition
                     class="absolute left-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-20 w-48 max-h-48 overflow-y-auto">
                    <template x-for="tag in allTags.filter(t => !(doc?.tags || []).some(dt => dt.id === t.id))" :key="tag.id">
                        <button @click="addTag(tag.id); open = false" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full" :style="`background-color: ${tag.color || '#6B7280'}`"></span>
                            <span x-text="tag.name"></span>
                        </button>
                    </template>
                    <div x-show="allTags.filter(t => !(doc?.tags || []).some(dt => dt.id === t.id)).length === 0" class="px-3 py-2 text-xs text-gray-400">Keine Tags verfügbar</div>
                </div>
            </div>
        </div>

        <!-- Collections with picker -->
        <div class="flex items-center gap-2 mt-2 flex-wrap">
            <span class="text-sm text-gray-500">Collections:</span>
            <template x-for="c in (doc?.collections || [])" :key="c.id">
                <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full text-white" :style="`background-color: ${c.color}`">
                    <a :href="'/collections/' + c.id" x-text="c.name" class="hover:underline"></a>
                    <button @click="removeFromCollection(c.id)" class="hover:text-red-200 ml-0.5">&times;</button>
                </span>
            </template>
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open; if(open) loadAllCollections()" class="text-xs px-2 py-0.5 rounded-full border border-dashed border-gray-300 dark:border-gray-600 text-gray-400 hover:text-gray-600 hover:border-gray-400">+ Collection</button>
                <div x-show="open" @click.away="open = false" x-transition
                     class="absolute left-0 top-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-20 w-48 max-h-48 overflow-y-auto">
                    <template x-for="c in allCollections.filter(c => !(doc?.collections || []).some(dc => dc.id === c.id))" :key="c.id">
                        <button @click="addToCollection(c.id); open = false" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full" :style="`background-color: ${c.color}`"></span>
                            <span x-text="c.name"></span>
                        </button>
                    </template>
                    <div x-show="allCollections.filter(c => !(doc?.collections || []).some(dc => dc.id === c.id)).length === 0" class="px-3 py-2 text-xs text-gray-400">Keine Collections verfügbar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <nav class="flex gap-6">
            <button @click="tab = 'chunks'" class="pb-3 text-sm font-medium border-b-2 transition-colors"
                    :class="tab === 'chunks' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700'">
                Chunks (<span x-text="chunks.length"></span>)
            </button>
            <button @click="tab = 'entities'" class="pb-3 text-sm font-medium border-b-2 transition-colors"
                    :class="tab === 'entities' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700'">
                Entities (<span x-text="entities.length"></span>)
            </button>
            <button x-show="doc?.platform === 'youtube'" @click="tab = 'transcript'; loadTranscript()" class="pb-3 text-sm font-medium border-b-2 transition-colors"
                    :class="tab === 'transcript' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700'">
                Transkript
            </button>
            <button @click="tab = 'graph'; $nextTick(() => loadGraph())" class="pb-3 text-sm font-medium border-b-2 transition-colors"
                    :class="tab === 'graph' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700'">
                Graph
            </button>
        </nav>
    </div>

    <!-- Chunks tab -->
    <div x-show="tab === 'chunks'" class="space-y-3">
        <template x-for="(chunk, i) in chunks" :key="chunk.chunk_id">
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-gray-400">Chunk #<span x-text="chunk.chunk_index"></span></span>
                    <div class="flex items-center gap-3 text-xs text-gray-400">
                        <span x-show="chunk.start_time !== undefined" x-text="'@' + Math.floor((chunk.start_time || 0) / 60) + ':' + String(Math.floor((chunk.start_time || 0) % 60)).padStart(2, '0')"></span>
                        <span x-text="chunk.content.length + ' Zeichen'"></span>
                    </div>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="chunk.content.substring(0, 500) + (chunk.content.length > 500 ? '...' : '')"></p>
            </div>
        </template>
    </div>

    <!-- Entities tab -->
    <div x-show="tab === 'entities'">
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 uppercase">
                        <th class="px-6 py-3">Name</th>
                        <th class="px-6 py-3">Typ</th>
                        <th class="px-6 py-3">Konfidenz</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="(e, idx) in entities" :key="idx">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                            <td class="px-6 py-3 font-medium" x-text="e.name"></td>
                            <td class="px-6 py-3">
                                <span class="text-xs px-2 py-0.5 rounded-full" :class="entityTypeBadge(e.entity_type)" x-text="e.entity_type"></span>
                            </td>
                            <td class="px-6 py-3 text-sm text-gray-500" x-text="e.confidence ? e.confidence.toFixed(2) : '—'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Transcript tab -->
    <div x-show="tab === 'transcript'">
        <div x-show="transcriptLoading" class="flex items-center justify-center py-12">
            <div class="animate-spin w-6 h-6 border-2 border-primary-500 border-t-transparent rounded-full"></div>
            <span class="ml-2 text-gray-500">Transkript wird geladen...</span>
        </div>
        <div x-show="!transcriptLoading && !transcriptData?.available" class="p-12 text-center text-gray-500">
            Kein Transkript verfügbar
        </div>
        <div x-show="!transcriptLoading && transcriptData?.available">
            <!-- Source badge -->
            <div class="flex items-center gap-3 mb-4">
                <span class="text-xs font-medium px-2.5 py-1 rounded-full"
                      :class="transcriptSourceBadge(transcriptData?.source)">
                    <span x-text="transcriptSourceLabel(transcriptData?.source)"></span>
                </span>
                <span class="text-sm text-gray-500" x-text="(transcriptData?.segment_count || 0) + ' Segmente'"></span>
            </div>
            <!-- Transcript segments -->
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 max-h-[600px] overflow-y-auto">
                <template x-for="(seg, i) in (transcriptData?.segments || [])" :key="i">
                    <div class="flex gap-4 px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700/30 border-b border-gray-100 dark:border-gray-700/50 last:border-b-0">
                        <a :href="doc?.source_url + '&t=' + Math.floor(seg.start)" target="_blank"
                           class="text-xs font-mono text-primary-500 hover:text-primary-600 whitespace-nowrap pt-0.5 flex-shrink-0 w-16 text-right"
                           x-text="Math.floor(seg.start / 3600) > 0 ? Math.floor(seg.start / 3600) + ':' + String(Math.floor((seg.start % 3600) / 60)).padStart(2, '0') + ':' + String(Math.floor(seg.start % 60)).padStart(2, '0') : Math.floor(seg.start / 60) + ':' + String(Math.floor(seg.start % 60)).padStart(2, '0')">
                        </a>
                        <p class="text-sm text-gray-700 dark:text-gray-300" x-text="seg.text"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Graph tab -->
    <div x-show="tab === 'graph'" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4" style="height: 500px">
        <div id="doc-graph" style="height: 100%"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
<script>
function ytThumbnail(url) {
    if (!url) return null;
    const m = url.match(/[?&]v=([^&]+)/);
    return m ? `https://img.youtube.com/vi/${m[1]}/mqdefault.jpg` : null;
}

function documentDetail(docId) {
    return {
        doc: null,
        chunks: [],
        entities: [],
        tab: 'chunks',
        quality: 0,
        flagged: false,
        allTags: [],
        allCollections: [],
        reIngesting: false,
        graphLoaded: false,
        transcriptData: null,
        transcriptLoading: false,
        transcriptLoaded: false,
        async load() {
            const [docResp, chunksResp, entResp] = await Promise.all([
                fetch(`/api/documents/${docId}`),
                fetch(`/api/documents/${docId}/chunks`),
                fetch(`/api/documents/${docId}/entities`),
            ]);
            this.doc = await docResp.json();
            const chunksData = await chunksResp.json();
            this.chunks = chunksData.chunks;
            const entData = await entResp.json();
            this.entities = entData.entities;
            this.quality = this.doc.quality_score || 0;
            this.flagged = this.doc.flagged || false;
        },
        async loadTranscript() {
            if (this.transcriptLoaded) return;
            this.transcriptLoading = true;
            try {
                const resp = await fetch(`/api/documents/${docId}/transcript`);
                this.transcriptData = await resp.json();
            } catch (e) {
                this.transcriptData = { available: false, segments: [], source: null, segment_count: 0 };
            }
            this.transcriptLoading = false;
            this.transcriptLoaded = true;
        },
        transcriptSourceLabel(source) {
            const labels = {
                'api': 'YouTube API (fein)',
                'whisper': 'Whisper (KI)',
                'chunks_reconstructed': 'Aus Chunks (60s)',
            };
            return labels[source] || source || '?';
        },
        transcriptSourceBadge(source) {
            const classes = {
                'api': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300',
                'whisper': 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300',
                'chunks_reconstructed': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
            };
            return classes[source] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
        },
        async setQuality(score) {
            this.quality = score;
            await fetch(`/api/documents/${docId}/quality`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quality_score: score }),
            });
            showToast(`Qualität: ${score}/5`);
        },
        async toggleFlag() {
            this.flagged = !this.flagged;
            await fetch(`/api/documents/${docId}/flag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ flagged: this.flagged }),
            });
            showToast(this.flagged ? 'Dokument markiert' : 'Markierung entfernt');
        },
        async reIngest() {
            if (!confirm('Dokument neu ingesten? Das alte wird gelöscht und neu verarbeitet.')) return;
            this.reIngesting = true;
            try {
                const resp = await fetch(`/api/documents/${docId}/re-ingest`, { method: 'POST' });
                const data = await resp.json();
                showToast(`Neu ingestet: ${data.chunks} Chunks, ${data.entities} Entities`);
                window.location.href = '/documents/' + data.document_id;
            } catch (e) { showToast('Fehler beim Re-Ingest', 'error'); }
            this.reIngesting = false;
        },
        async confirmDelete() {
            if (!confirm('Dokument wirklich löschen? Alle Vektoren, Entities und Metadaten werden entfernt.')) return;
            await fetch(`/api/documents/${docId}`, { method: 'DELETE' });
            window.location.href = '/documents';
        },
        async loadAllTags() {
            const resp = await fetch('/api/tags');
            const data = await resp.json();
            this.allTags = data.tags;
        },
        async addTag(tagId) {
            const currentTagIds = (this.doc.tags || []).map(t => t.id);
            currentTagIds.push(tagId);
            await fetch(`/api/documents/${docId}/tags`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentTagIds),
            });
            this.load();
            showToast('Tag hinzugefügt');
        },
        async removeTag(tagId) {
            const currentTagIds = (this.doc.tags || []).filter(t => t.id !== tagId).map(t => t.id);
            await fetch(`/api/documents/${docId}/tags`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentTagIds),
            });
            this.load();
        },
        async loadAllCollections() {
            const resp = await fetch('/api/collections');
            const data = await resp.json();
            this.allCollections = data.collections;
        },
        async addToCollection(collId) {
            await fetch(`/api/collections/${collId}/documents`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ document_id: docId }),
            });
            this.load();
            showToast('Zu Collection hinzugefügt');
        },
        async removeFromCollection(collId) {
            await fetch(`/api/collections/${collId}/documents/${docId}`, { method: 'DELETE' });
            this.load();
        },
        async loadGraph() {
            if (this.graphLoaded) return;
            try {
                const resp = await fetch(`/api/graph/document/${docId}`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (typeof renderGraph === 'function' && data.nodes && data.nodes.length > 0) {
                        renderGraph('doc-graph', data);
                        this.graphLoaded = true;
                    } else {
                        document.getElementById('doc-graph').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Kein Graph verfügbar</div>';
                    }
                }
            } catch (e) {
                document.getElementById('doc-graph').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Graph konnte nicht geladen werden</div>';
            }
        },
        entityTypeBadge(t) {
            const map = {
                PERSON: 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
                ORGANIZATION: 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300',
                LOCATION: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
                TOPIC: 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300',
                EVENT: 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300',
            };
            return map[t] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
        }
    }
}
</script>
<script src="/static/js/graph.js"></script>
{% endblock %}
